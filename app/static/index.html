<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Air Audit • v1</title>
  <style>
    :root { --bd: #e5e7eb; --muted:#6b7280; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 24px; line-height: 1.35; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; padding-bottom:12px; border-bottom:1px solid var(--bd); margin-bottom:16px; }
    .brand { font-weight:600; }
    nav a { margin-right:12px; text-decoration:none; padding:6px 10px; border:1px solid var(--bd); border-radius:8px; color:#111827; }
    nav a.active { background:#111827; color:white; }
    nav a.disabled { pointer-events:none; opacity:.5; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input, button, select { padding:8px 10px; font-size:14px; }
    section { border: 1px solid var(--bd); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    .card { border:1px solid var(--bd); border-radius:10px; padding:12px; }
    .muted { color: var(--muted); }
    .small { font-size:12px; }
    .toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:10px; }
    .list { display:grid; gap:8px; }
    .item { border:1px solid var(--bd); border-radius:8px; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    .link { color:#2563eb; cursor:pointer; text-decoration:underline; }
    .pill { border:1px solid var(--bd); border-radius:999px; padding:2px 8px; font-size:12px; }
    .warn { color:#b45309; }
    .ok { color:#065f46; }
    .err { color:#991b1b; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <div class="brand">✈️ Air Audit <span class="muted">• v1</span></div>
    <div class="row">
      <label for="aircraftSelect">Avión:</label>
      <select id="aircraftSelect" onchange="onAircraftChange()"></select>
    </div>
    <nav>
      <a id="navWelcome" href="#/welcome">Inicio</a>
      <a id="navItems" href="#/aircraft/0/items" class="disabled">Ítems</a>
      <a id="navEdit" href="#" onclick="goNew()">Editar</a>
      <a id="navAudit" href="#/aircraft/0/audit" class="disabled">Historial</a>
    </nav>
  </header>

  <!-- Screen: Welcome -->
  <section id="screenWelcome" class="hidden">
    <h2>Bienvenido al servicio de auditoría de aviones</h2>
    <div class="toolbar">
      <div class="row">
        <input id="filterAircraft" placeholder="Buscar avión por nombre..." />
        <button onclick="renderAircraftGrid()">Buscar</button>
        <label class="small" style="margin-left:8px;">
          <input type="checkbox" id="showArchived" onchange="ensureAircrafts().then(renderAircraftGrid)"> Mostrar archivados
        </label>
      </div>
      <div class="row">
        <input id="filterAircraft" placeholder="Buscar avión por nombre..." />
        <button onclick="renderAircraftGrid()">Buscar</button>
      </div>
      <div class="row">
        <input id="newAircraftName" placeholder="Nombre del avión" />
        <input id="newAircraftModel" placeholder="Modelo (opcional)" />
        <button onclick="createAircraft()">Agregar avión</button>
      </div>
    </div>
    <div id="aircraftGrid" class="grid"></div>
  </section>

  <!-- Screen: Items -->
  <section id="screenItems" class="hidden">
    <h2>Ítems publicados</h2>
    <div class="toolbar">
      <div class="row">
        <input id="searchItems" placeholder="Buscar por descripción o código..." />
        <select id="pageSize" onchange="loadItems()">
          <option>50</option>
          <option>100</option>
          <option>250</option>
          <option>500</option>
        </select>
        <button onclick="loadItems()">Buscar</button>
      </div>
      <div class="row">
        <button onclick="toggleImport()">Importar CSV</button>  <!-- NUEVO -->
        <button onclick="goNew()">+ Agregar ítem</button>
      </div>
    </div>
    <div id="importPanel" class="hidden" style="border:1px solid var(--bd); border-radius:8px; padding:12px; margin-top:8px;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="small"><b>Importar desde CSV</b> (los válidos se publican; duplicados a cuarentena)</div>
        <div><span class="link" onclick="toggleImport()">Cerrar ✕</span></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="csvFile" type="file" accept=".csv,text/csv" />
        <select id="publishMode">
          <option value="quarantine">Publicar + Cuarentena (recomendado)</option>
          <option value="strict">Estricta (falla si hay errores)</option>
        </select>
        <button onclick="importCSV()">Subir</button>
      </div>
      <pre id="importResult" class="small" style="background:#f9fafb; border:1px solid var(--bd); border-radius:8px; padding:8px; margin-top:8px;"></pre>
    </div>
    <div class="row">
      <button onclick="prevPage()">◀ Anterior</button>
      <div id="pageInfo" class="small muted"></div>
      <button onclick="nextPage()">Siguiente ▶</button>
    </div>
    <div id="itemsList" class="list" style="margin-top:10px;"></div>
  </section>

  <!-- Screen: Edit/New -->
  <section id="screenEdit" class="hidden">
    <h2 id="editTitle">Editar ítem</h2>
    <div class="small"><span class="link" onclick="goItems()">← Volver a Ítems</span></div>
    <div id="warnBox" class="small warn"></div>
    <div class="grid" style="grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); margin-top:10px;">
      <div><label>Código</label><br><input id="f_item_code"></div>
      <div><label>Posición</label><br><input id="f_position"></div>
      <div><label>Descripción *</label><br><input id="f_description"></div>
      <div><label>Tipo</label><br><input id="f_type" placeholder="sbsl/comp/ad/insp"></div>
      <div><label>Interval (months)</label><br><input id="f_interval_months" type="number" min="0"></div>
      <div><label>Interval (hours)</label><br><input id="f_interval_hours" type="number" min="0"></div>
      <div><label>Interval (landings)</label><br><input id="f_interval_landings" type="number" min="0"></div>
      <div><label>Due Next (date)</label><br><input id="f_due_next_date" type="date"></div>
      <div><label>Due Next (hours)</label><br><input id="f_due_next_hours" type="number" min="0"></div>
      <div><label>Due Next (landings)</label><br><input id="f_due_next_landings" type="number" min="0"></div>
      <div><label>Status</label><br><input id="f_status"></div>
      <div><label>Status Note</label><br><input id="f_status_note"></div>
      <div><label>Part Number</label><br><input id="f_part_number"></div>
      <div><label>Part Serial</label><br><input id="f_part_serial"></div>
      <div><label>Last Completed (date)</label><br><input id="f_last_completed_date" type="date"></div>
      <div><label>Last Completed (hours)</label><br><input id="f_last_completed_hours" type="number" min="0"></div>
      <div><label>Last Completed (landings)</label><br><input id="f_last_completed_landings" type="number" min="0"></div>
      <div><label>Ciudad</label><br><input id="f_last_completed_city"></div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button onclick="saveItem()">Guardar</button>
      <button onclick="goItems()">Cancelar</button>
    </div>
  </section>
  <section id="screenAudit" class="hidden">
  <h2>Historial del avión</h2>
  <div class="toolbar">
    <div class="row">
      <label class="small">
        <input type="checkbox" id="auditAll" onchange="state.auditPage=1; loadAudit()"> Todos los aviones
      </label>
    </div>
    <div class="row">
      <button onclick="prevAuditPage()">◀ Anterior</button>
      <div id="auditPageInfo" class="small muted"></div>
      <button onclick="nextAuditPage()">Siguiente ▶</button>
    </div>
  </div>
  <div id="auditList" class="list"></div>
  </section>

<script>
// ---- State ----
let state = {
  aircrafts: [],
  selectedAircraftId: null,
  items: [],
  page: 1,
  pageSize: 50,
  total: 0,
  editingItemId: null,
  showImportPanel: false,
};

const api = (path, opts={}) => fetch(path, opts).then(async r => {
  if (!r.ok) {
    let detail = "";
    try { const j = await r.json(); detail = j.detail || JSON.stringify(j); } catch(e){ detail = r.statusText; }
    throw new Error(detail);
  }
  return r.json();
});

function el(id){ return document.getElementById(id); }
function setActive(tab){ ["navWelcome","navItems","navEdit","navAudit"].forEach(id => el(id).classList.remove("active")); el(tab).classList.add("active"); }
function show(screenId){ ["screenWelcome","screenItems","screenEdit","screenAudit"].forEach(id => el(id).classList.add("hidden")); el(screenId).classList.remove("hidden"); }
function getSelectedAircraftId(){ return parseInt(el("aircraftSelect").value || "0"); }
function setSelectedAircraftId(id){ el("aircraftSelect").value = String(id); localStorage.setItem("aircraftId", String(id)); updateNavLinks(); }

// --- Routing (hash) ---
window.addEventListener("hashchange", router);
async function router(){
  updateNavLinks();
  const hash = location.hash || "#/welcome";
  const parts = hash.replace("#","").split("/").filter(Boolean);
  // parts example: ["aircraft","1","items","123","edit"]
  if (parts[0] === "welcome") {
    setActive("navWelcome"); show("screenWelcome");
    await ensureAircrafts(); renderAircraftGrid();
    return;
  }
  
  if (parts[0] === "aircraft" && parts[2] === "items") {
  const aid = parseInt(parts[1] || "0");
  if (!aid || !state.aircrafts.find(a => a.id === aid)) { await ensureAircrafts(); }
  setSelectedAircraftId(aid || state.selectedAircraftId || (state.aircrafts[0]?.id || 0));

  // --- 1) NUEVO: crear ítem ---
  if (parts.length >= 4 && parts[3] === "new") {
    setActive("navEdit");
    show("screenEdit");
    state.editingItemId = null;
    clearForm();
    el("editTitle").innerText = "Nuevo ítem";
    return;
  }

  // --- 2) NUEVO: editar ítem ---
  if (parts.length >= 5 && parts[4] === "edit") {
    const itemId = parseInt(parts[3] || "0");
    setActive("navEdit");
    show("screenEdit");
    state.editingItemId = itemId;
    el("editTitle").innerText = "Editar ítem #" + itemId;
    await loadItem(itemId);
    return;
  }

  // --- 3) Default: listar ítems ---
  setActive("navItems");
  show("screenItems");
  await loadItems();

  // Abrir panel de import si venimos desde "Importar CSV"
  if (localStorage.getItem('openImport') === '1') {
    state.showImportPanel = true;
    localStorage.removeItem('openImport');
  }
  renderImportPanel();
  return;
  }


  if (parts[0] === "aircraft" && parts[2] === "audit") {
    const aid = parseInt(parts[1] || "0");
    if (!aid || !state.aircrafts.find(a => a.id === aid)) { await ensureAircrafts(); }
    setSelectedAircraftId(aid || state.selectedAircraftId || (state.aircrafts[0]?.id || 0));
    setActive("navAudit"); show("screenAudit");
    state.auditPage = Number(state.auditPage) || 1;
    state.auditPageSize = Number(state.auditPageSize) || 50;
    await loadAudit();
    return;
  }
  // default
  location.hash = "#/welcome";
}

// --- Aircrafts ---
async function ensureAircrafts(){
  const ia = el("showArchived")?.checked ? 1 : 0;
  const list = await api('/aircraft' + (ia ? '?include_archived=1' : ''));
  state.aircrafts = list;
  const sel = el('aircraftSelect');
  sel.innerHTML = '';
  list.forEach(a => sel.add(new Option(`#${a.id} ${a.name} (${a.model})`, a.id)));
  const saved = parseInt(localStorage.getItem("aircraftId") || "0");
  const toUse = saved || (list[0]?.id || 0);
  if (toUse) setSelectedAircraftId(toUse);
  updateNavLinks();
}

function updateNavLinks(){
  const aid = getSelectedAircraftId() || 0;
  const items = el("navItems");
  const edit  = el("navEdit");
  const audit = el("navAudit");  // NUEVO
  if (aid) {
    items.classList.remove("disabled");
    edit.classList.remove("disabled");
    audit.classList.remove("disabled");                   // NUEVO
    items.href = `#/aircraft/${aid}/items`;
    edit.href  = `#/aircraft/${aid}/items/new`;
    audit.href = `#/aircraft/${aid}/audit`;               // NUEVO
  } else {
    items.classList.add("disabled");
    edit.classList.add("disabled");
    audit.classList.add("disabled");                      // NUEVO
    items.href = "#/aircraft/0/items";
    edit.href  = "#/aircraft/0/items/new";
    audit.href = "#/aircraft/0/audit";                    // NUEVO
  }
}

function onAircraftChange(){
  const id = getSelectedAircraftId();
  setSelectedAircraftId(id);   // guarda y refresca enlaces del header

  const parts = (location.hash || "#/welcome").replace("#","").split("/").filter(Boolean);

  if (parts[0] === "aircraft" && parts[2] === "items") {
    if (parts.length >= 4 && parts[3] === "new") {
      location.hash = `#/aircraft/${id}/items/new`;
    } else if (parts.length >= 5 && parts[4] === "edit") {
      const itemId = parseInt(parts[3] || "0");
      location.hash = `#/aircraft/${id}/items/${itemId}/edit`;
    } else {
      location.hash = `#/aircraft/${id}/items`;
    }
  } else if (parts[0] === "aircraft" && parts[2] === "audit") {
    // Si estás en Historial, que cambie el historial al nuevo avión
    location.hash = `#/aircraft/${id}/audit`;
  } else {
    // En Inicio u otra vista: solo refrescamos enlaces
    updateNavLinks();
  }
}

// welcome
function renderAircraftGrid(){
  const q = (el("filterAircraft").value || "").toLowerCase();
  const cont = el("aircraftGrid");
  const list = state.aircrafts.filter(a => a.name.toLowerCase().includes(q));
  if (list.length === 0){
    cont.innerHTML = '<div class="muted">No hay aviones.</div>'; return;
  }
  cont.innerHTML = list.map(a => {
    const archived = a.is_active === 0;
    const actions = archived
      ? `<a class="link" href="#/aircraft/${a.id}/items" onclick="event.preventDefault(); restoreAircraft(${a.id})">Restaurar</a>`
      : `<a class="link" href="#/aircraft/${a.id}/items" onclick="event.preventDefault(); archiveAircraft(${a.id})">Archivar</a>`;
    return `
      <div class="card">
        <div><b>${a.name}</b> <span class="muted">(${a.model || 'N/A'})</span></div>
        <div class="small muted">Creado: ${a.created_at}</div>
        ${archived ? `<div class="small warn">Archivado: ${a.archived_at || ''}</div>` : ''}
        <div style="margin-top:8px; display:flex; gap:14px; flex-wrap:wrap;">
          <!-- Navegación por hash (sin JS extra) -->
          <a class="link" href="#/aircraft/${a.id}/items">Ver ítems</a>

          <!-- Para abrir el panel de importación, marcamos un flag y navegamos -->
          <a class="link" href="#/aircraft/${a.id}/items"
            onclick="localStorage.setItem('openImport','1')">Importar CSV</a>

        ${actions}
      </div>
    </div>
  `;
}).join("");
}

async function createAircraft(){
  const name = el("newAircraftName").value.trim();
  const model = el("newAircraftModel").value.trim();
  if (!name){ alert("Nombre requerido"); return; }
  const fd = new FormData(); fd.append('name', name); fd.append('model', model || 'N/A');
  try{
    const res = await api('/aircraft', { method: 'POST', body: fd });
    el('newAircraftName').value = ""; el('newAircraftModel').value = "";
    await ensureAircrafts(); renderAircraftGrid();
    // Preguntar si importar ahora
    const importar = confirm("Avión creado (#"+res.id+"). ¿Quieres importar un CSV ahora?");
    if (importar){
      setSelectedAircraftId(res.id);
      state.showImportPanel = true;  // abrir panel
      location.hash = `#/aircraft/${res.id}/items`;
    }
  }catch(e){ alert("Error al crear avión: "+e.message); }
}

async function archiveAircraft(aid){
  if (!confirm("¿Archivar este avión? Podrás restaurarlo luego.")) return;
  try{
    await api(`/aircraft/${aid}/archive`, { method:'POST' });
    await ensureAircrafts(); renderAircraftGrid();
  }catch(e){ alert("No se pudo archivar: " + e.message); }
}

async function restoreAircraft(aid){
  try{
    await api(`/aircraft/${aid}/restore`, { method:'POST' });
    await ensureAircrafts(); renderAircraftGrid();
  }catch(e){ alert("No se pudo restaurar: " + e.message); }
}

// nav helpers
function goItemsFor(aid){location.hash = `#/aircraft/${aid}/items`;}
function goItems(){ const aid = getSelectedAircraftId(); location.hash = `#/aircraft/${aid}/items`; }
function goNew(){ const aid = getSelectedAircraftId(); location.hash = `#/aircraft/${aid}/items/new`; }

// --- Items (list) ---
async function loadItems(){
  const aid = getSelectedAircraftId(); if (!aid){ alert("Selecciona un avión"); return; }
  state.pageSize = parseInt(el("pageSize").value || "50"); 
  const search = el("searchItems").value || "";
  const offset = (state.page-1) * state.pageSize;
  const qs = `?limit=${state.pageSize}&offset=${offset}${search ? "&search="+encodeURIComponent(search):""}`;
  const [items, count] = await Promise.all([
    api(`/aircraft/${aid}/items${qs}`),
    api(`/aircraft/${aid}/items/count${search ? "?search="+encodeURIComponent(search):""}`)
  ]);
  state.items = items; state.total = count.count;
  const totalPages = Math.max(1, Math.ceil(state.total/state.pageSize));
  el("pageInfo").innerText = `Página ${state.page} de ${totalPages} • Total: ${state.total}`;
  const list = el("itemsList");
  if (items.length === 0){
    list.innerHTML = '<div class="muted">Sin resultados.</div>'; return;
  }
  list.innerHTML = items.map(r => `
    <div class="item">
      <div>
        <div><b>${escapeHtml(r.description || '(sin descripción)')}</b></div>
        <div class="small muted">${escapeHtml(r.item_code || '')} • ${escapeHtml(r.position || '')} • ${escapeHtml(r.type || '')}</div>
        <div class="small">DueH: ${r.due_next_hours ?? ''} • DueL: ${r.due_next_landings ?? ''} • DueD: ${r.due_next_date ?? ''}</div>
        <div class="small muted">#${r.id}</div>
      </div>
      <a class="link" href="#/aircraft/${getSelectedAircraftId()}/items/${r.id}/edit">✏️ Editar</a>
    </div>
  `).join("");
}

function prevPage(){ if (state.page>1){ state.page--; loadItems(); } }
function nextPage(){ const totalPages = Math.max(1, Math.ceil(state.total/state.pageSize)); if (state.page<totalPages){ state.page++; loadItems(); } }
function editItem(id){ const aid = getSelectedAircraftId(); location.hash = `#/aircraft/${aid}/items/${id}/edit`; }

// --- Import CSV ---
function renderImportPanel(){
  const panel = el("importPanel");
  if (!panel) return;
  panel.classList.toggle("hidden", !state.showImportPanel);
  if (!state.showImportPanel) {
    el("csvFile").value = "";
    el("importResult").textContent = "";
  }
}
function toggleImport(){
  state.showImportPanel = !state.showImportPanel;
  renderImportPanel();
}
async function importCSV(){
  const aid = getSelectedAircraftId();
  const f = el("csvFile").files[0];
  const mode = el("publishMode").value || "quarantine";
  if (!aid){ alert("Selecciona un avión"); return; }
  if (!f){ alert("Selecciona un archivo CSV"); return; }
  const fd = new FormData();
  fd.append("file", f); // la API espera el campo 'file'
  el("importResult").textContent = "Subiendo y procesando...";
  try{
    const res = await api(`/aircraft/${aid}/imports?publish_mode=${encodeURIComponent(mode)}`, {
      method: 'POST',
      body: fd
    });
    // Resumen amigable
    const summary = [
      `Lote #${res.import_batch_id || 'N/A'}`,
      `Estado: ${res.status}`,
      `Total filas: ${res.total_rows}`,
      `Insertados: ${res.inserted_rows}`,
      `Cuarentena: ${res.quarantined || 0}`,
      `Errores: ${res.errors}`
    ].join('\n');
    el("importResult").textContent = summary;
    // refrescar items publicados
    await loadItems();
  }catch(e){
    // Errores típicos: 409 si el mismo archivo ya fue importado para ese avión
    el("importResult").textContent = "Error: " + e.message;
  }
}


// --- Edit/New form ---
function clearForm(){
  ["f_item_code","f_position","f_description","f_type","f_interval_months","f_interval_hours","f_interval_landings",
   "f_due_next_date","f_due_next_hours","f_due_next_landings","f_status","f_status_note","f_part_number","f_part_serial",
   "f_last_completed_date","f_last_completed_hours","f_last_completed_landings","f_last_completed_city"].forEach(id => el(id).value = "");
  el("warnBox").innerText = "";
}

async function loadItem(id){
  clearForm();
  const r = await api(`/items/${id}`);
  setForm(r);
  // warnings (non-blocking)
  if (r.due_next_date && r.last_completed_date && r.due_next_date < r.last_completed_date){
    el("warnBox").innerText = "⚠️ El vencimiento es anterior a la última finalización. Revisa si es correcto.";
  }
}

function setForm(r){
  el("f_item_code").value = r.item_code || "";
  el("f_position").value = r.position || "";
  el("f_description").value = r.description || "";
  el("f_type").value = r.type || "";
  el("f_interval_months").value = r.interval_months ?? "";
  el("f_interval_hours").value = r.interval_hours ?? "";
  el("f_interval_landings").value = r.interval_landings ?? "";
  el("f_due_next_date").value = r.due_next_date || "";
  el("f_due_next_hours").value = r.due_next_hours ?? "";
  el("f_due_next_landings").value = r.due_next_landings ?? "";
  el("f_status").value = r.status || "";
  el("f_status_note").value = r.status_note || "";
  el("f_part_number").value = r.part_number || "";
  el("f_part_serial").value = r.part_serial || "";
  el("f_last_completed_date").value = r.last_completed_date || "";
  el("f_last_completed_hours").value = r.last_completed_hours ?? "";
  el("f_last_completed_landings").value = r.last_completed_landings ?? "";
  el("f_last_completed_city").value = r.last_completed_city || "";
}

function getForm(){
  const v = (id) => el(id).value.trim();
  const toInt = (s) => s==="" ? null : parseInt(s,10);
  const payload = {
    item_code: v("f_item_code") || null,
    position: v("f_position") || null,
    description: v("f_description") || null,
    type: v("f_type") || null,
    interval_months: toInt(v("f_interval_months")),
    interval_hours: toInt(v("f_interval_hours")),
    interval_landings: toInt(v("f_interval_landings")),
    due_next_date: v("f_due_next_date") || null,
    due_next_hours: toInt(v("f_due_next_hours")),
    due_next_landings: toInt(v("f_due_next_landings")),
    status: v("f_status") || null,
    status_note: v("f_status_note") || null,
    part_number: v("f_part_number") || null,
    part_serial: v("f_part_serial") || null,
    last_completed_date: v("f_last_completed_date") || null,
    last_completed_hours: toInt(v("f_last_completed_hours")),
    last_completed_landings: toInt(v("f_last_completed_landings")),
    last_completed_city: v("f_last_completed_city") || null,
  };
  return payload;
}

async function saveItem(){
  const aid = getSelectedAircraftId();
  const payload = getForm();
  if (!payload.description){ alert("La descripción es requerida."); return; }
  try{
    if (state.editingItemId){
      await api(`/items/${state.editingItemId}`, { method:'PUT', headers: { "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      alert("Ítem actualizado.");
    } else {
      await api(`/aircraft/${aid}/items`, { method:'POST', headers: { "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      alert("Ítem creado.");
    }
    goItems();
    await loadItems();
  }catch(e){ alert("Error al guardar: "+e.message); }
}

async function loadAudit(){
  const aid = getSelectedAircraftId();

  const pageSize = Number.isFinite(Number(state.auditPageSize)) ? Number(state.auditPageSize) : 50;
  const page = Number.isFinite(Number(state.auditPage)) ? Number(state.auditPage) : 1;
  const offset = Math.max(0, (page - 1) * pageSize);

  const qs = `?limit=${pageSize}&offset=${offset}`;
  const all = !!(el("auditAll") && el("auditAll").checked);
  const url = all ? `/audit${qs}` : `/aircraft/${aid}/audit${qs}`;

  try{
    const items = await api(url);
    el("auditPageInfo").innerText = `Página ${page}`;
    if (!Array.isArray(items) || items.length === 0){
      el("auditList").innerHTML = '<div class="muted small">No hay eventos para este criterio.</div>';
      return;
    }
    el("auditList").innerHTML = items.map(renderAuditItem).join("");
  }catch(err){
    let msg = err?.message || String(err);
    // Si viene una lista de errores, muéstrala legible
    try {
      if (msg === "[object Object]" || msg.includes("[object Object]")) {
        msg = JSON.stringify(err);
      }
    } catch(_) {}
    el("auditList").innerHTML = `<div class="err small">Error al cargar historial: ${escapeHtml(msg)}</div>`;
  }
}

function prevAuditPage(){ if (state.auditPage > 1){ state.auditPage--; loadAudit(); } }
function nextAuditPage(){ state.auditPage++; loadAudit(); }

function renderAuditItem(ev){
  const ts   = ev.ts;
  const tbl  = ev.table_name;
  const act  = ev.action;
  const rid  = ev.row_id;
  const det  = ev.details || {};
  let summary = "";

  if (tbl === "aircraft"){
    if (act === "CREATE"){
      summary = `✈️ Creado avión "${escapeHtml(det?.values?.name || '')}" (${escapeHtml(det?.values?.model || '')})`;
    } else if (act === "ARCHIVE"){
      summary = `📦 Archivado avión "${escapeHtml(det?.name || '')}"`;
    } else if (act === "RESTORE"){
      summary = `♻️ Restaurado avión "${escapeHtml(det?.name || '')}"`;
    } else {
      summary = `✈️ Evento de avión (${act})`;
    }
  } else if (tbl === "maintenance_item"){
    if (act === "INSERT"){
      summary = `➕ Ítem creado (id=${rid})`;
    } else if (act === "UPDATE"){
      const fields = det?.diff ? Object.keys(det.diff) : [];
      summary = `✏️ Ítem actualizado (id=${rid}) — campos: ${fields.join(", ")}`;
    } else {
      summary = `Ítem evento (${act}) (id=${rid})`;
    }
  } else if (tbl === "import_batch"){
    summary = `📥 Lote ${rid} — acción: ${act}`;
  } else {
    summary = `${tbl} — ${act}`;
  }

  // Mostrar diff si existe
  let diffHtml = "";
  if (det && det.diff){
    const rows = Object.entries(det.diff).map(([k,v]) =>
      `<div class="small"><b>${escapeHtml(k)}</b>: ${escapeHtml(String(v.from))} → ${escapeHtml(String(v.to))}</div>`
    ).join("");
    diffHtml = rows ? `<div style="margin-top:6px;">${rows}</div>` : "";
  }

  return `
    <div class="item">
      <div>
        <div class="small muted">${ts}</div>
        <div><b>${summary}</b></div>
        ${diffHtml}
      </div>
    </div>
  `;
}

// escape
function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

// init
(async () => {
  await ensureAircrafts();
  if (!location.hash) location.hash = "#/welcome";
  router();
})();
</script>
</body>
</html>
