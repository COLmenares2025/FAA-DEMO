<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Air Audit v1</title>
  <style>
    :root { --bd: #e5e7eb; --muted:#6b7280; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 24px; line-height:1.35; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; padding-bottom:12px; border-bottom:1px solid var(--bd); margin-bottom:16px; flex-wrap:wrap; }
    .brand { font-weight:600; }
    nav a { margin-right:12px; text-decoration:none; padding:6px 10px; border:1px solid var(--bd); border-radius:8px; color:#111827; }
    nav a.active { background:#111827; color:white; }
    nav a.disabled { pointer-events:none; opacity:.5; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input, button, select { padding:8px 10px; font-size:14px; }
    section { border: 1px solid var(--bd); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    .card { border:1px solid var(--bd); border-radius:10px; padding:12px; }
    .muted { color: var(--muted); }
    .small { font-size:12px; }
    .toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:10px; }
    .list { display:grid; gap:8px; }
    .item { border:1px solid var(--bd); border-radius:8px; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    .link { color:#2563eb; cursor:pointer; text-decoration:underline; }
    .pill { border:1px solid var(--bd); border-radius:999px; padding:2px 8px; font-size:12px; }
    .warn { color:#b45309; }
    .ok { color:#065f46; }
    .err { color:#991b1b; }
    .hidden { display:none; }
    form.list > div { display:flex; flex-direction:column; gap:4px; }
  </style>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header id="appHeader" class="hidden">
    <div class="brand"><img src="/static/logo.png" alt="" class="brand-logo"> Air Audit</div>
    <nav>
      <a id="navWelcome" href="#/welcome">Inicio</a>
      <a id="navItems" href="#/aircraft/0/items" class="disabled">Ãtems</a>
            <a id="navAudit" href="#/aircraft/0/audit" class="disabled">Historial</a>
      <a id="navMTRs" href="#/mtrs" class="disabled">MTRs</a>
    </nav>
    <div class="row hidden" id="userBox">
      <div class="small">
        <div><b id="userName"></b></div>
        <div class="pill" id="userRole"></div>
      </div>
      <button type="button" onclick="logout()">Salir</button>
    </div>
  </header>

  <section id="screenLogin">
    <h2>Iniciar sesión</h2>
    <p class="muted small">Ingresa tus credenciales para continuar.</p>
    <form class="list" id="loginForm" onsubmit="login(event)" style="max-width:320px;">
      <div>
        <label for="loginUser">Usuario</label>
        <input id="loginUser" autocomplete="username" />
      </div>
      <div>
        <label for="loginPass">Contraseña</label>
        <input id="loginPass" type="password" autocomplete="current-password" />
      </div>
      <div>
        <button type="submit">Ingresar</button>
      </div>
    </form>
    <div id="loginError" class="err small"></div>
    <div class="small muted" style="margin-top:8px;">Usuarios demo: admin/admin123, mechanic/mechanic123, auditor/auditor123.</div>
  </section>

  <!-- Screen: MTRs List -->
  <section id="screenMTRs" class="hidden">
    <h2>MTRs</h2>
    <div class="toolbar">
      <div class="row">
        <button onclick="goNewMTR()" id="btnNewMTR">+ Nuevo MTR</button>
      </div>
    </div>
    <div id="mtrList" class="list"></div>
  </section>

  <!-- Screen: MTR Wizard -->
  <section id="screenMTRWizard" class="hidden">
    <h2 id="mtrWizardTitle">Nuevo MTR</h2>
    <div id="mtrWizard"></div>
  </section>

  <!-- Screen: Welcome -->
  <section id="screenWelcome" class="hidden">
    <h2>Bienvenido al servicio de auditoría de aviones</h2>
    <div class="toolbar">
      <div class="row">
        <input id="filterAircraft" placeholder="Buscar avión por nombre..." />
        <button onclick="renderAircraftGrid()">Buscar</button>
        <label class="small" style="margin-left:8px;">
          <input type="checkbox" id="showArchived" onchange="ensureAircrafts().then(renderAircraftGrid)"> Mostrar archivados
        </label>
      </div>
      
      <div class="row" id="rowNewAircraft">
        <input id="newAircraftName" placeholder="Nombre del aviÃ³n" />
        <input id="newAircraftModel" placeholder="Modelo (opcional)" />
        <button onclick="createAircraft()">Agregar avión</button>
      </div>      <div id="newAircraftTC" class="list" style="margin-top:8px;">
        <b>TIME & CYCLES del avión (requeridos)</b>
        <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(160px,1fr));">
          <div><label>Aircraft Hours</label><input id="newTC_aircraft_hours" type="number" step="0.1" min="0" /></div>
          <div><label>Aircraft Landings</label><input id="newTC_aircraft_landings" type="number" step="1" min="0" /></div>
          <div><label>APU Hours</label><input id="newTC_apu_hours" type="number" step="0.1" min="0" /></div>
          <div><label>APU Cycles</label><input id="newTC_apu_cycles" type="number" step="1" min="0" /></div>
          <div><label>Engine 1 Hours</label><input id="newTC_engine_1_hours" type="number" step="0.1" min="0" /></div>
          <div><label>Engine 1 Cycles</label><input id="newTC_engine_1_cycles" type="number" step="1" min="0" /></div>
          <div><label>Engine 2 Hours</label><input id="newTC_engine_2_hours" type="number" step="0.1" min="0" /></div>
          <div><label>Engine 2 Cycles</label><input id="newTC_engine_2_cycles" type="number" step="1" min="0" /></div>
        </div>
      </div>
    </div>
    <div id="aircraftGrid" class="grid"></div>
  </section>

  <!-- Screen: Items -->
  <section id="screenItems" class="hidden">
    <h2>Ítems publicados</h2>
    <div class="toolbar">
      <div class="row">
        <select id="aircraftSelect" onchange="onAircraftChange()"></select>
        <input id="searchItems" placeholder="Buscar por descripción o código..." />
        <select id="pageSize" onchange="loadItems()">
          <option>50</option>
          <option>100</option>
          <option>250</option>
          <option>500</option>
        </select>
        <button onclick="loadItems()">Buscar</button>
      </div>
      <div class="row">
        <button id="btnImportCsv" onclick="toggleImport()">Importar CSV</button>
        <button id="btnAddItem" onclick="goNew()">+ Agregar Ã­tem</button>
      </div>
    </div>
    <div id="tcInfo" class="small muted" style="margin:6px 0 10px 0;"></div>
    <div id="importPanel" class="hidden" style="border:1px solid var(--bd); border-radius:8px; padding:12px; margin-top:8px;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="small"><b>Importar desde CSV</b> (los válidos se publican; duplicados a cuarentena)</div>
        <div><span class="link" onclick="toggleImport()">Cerrar ✕</span></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="csvFile" type="file" accept=".csv,text/csv" />
        <select id="publishMode">
          <option value="quarantine">Publicar + Cuarentena (recomendado)</option>
          <option value="strict">Estricta (falla si hay errores)</option>
        </select>
        <button onclick="importCSV()">Subir</button>
      </div>
      <pre id="importResult" class="small" style="background:#f9fafb; border:1px solid var(--bd); border-radius:8px; padding:8px; margin-top:8px;"></pre>
    </div>
    <div class="row">
      <button onclick="prevPage()">← Anterior</button>
      <div id="pageInfo" class="small muted"></div>
      <button onclick="nextPage()">Siguiente →</button>
    </div>
    <div id="itemsList" class="list" style="margin-top:10px;"></div>
  </section>

  <!-- Screen: Edit/New -->
  <section id="screenEdit" class="hidden">
    <h2 id="editTitle">Editar Ã­tem</h2>
    <div class="small"><span class="link" onclick="goItems()">â† Volver a Ãtems</span></div>
    <div id="warnBox" class="small warn"></div>
    <div class="grid" style="grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); margin-top:10px;">
      <div><label>CÃ³digo</label><br><input id="f_item_code"></div>
      <div><label>PosiciÃ³n</label><br><input id="f_position"></div>
      <div><label>DescripciÃ³n *</label><br><input id="f_description"></div>
      <div><label>Tipo</label><br><input id="f_type" placeholder="sbsl/comp/ad/insp"></div>
      <div><label>Interval (months)</label><br><input id="f_interval_months" type="number" min="0"></div>
      <div><label>Interval (hours)</label><br><input id="f_interval_hours" type="number" min="0"></div>
      <div><label>Interval (landings)</label><br><input id="f_interval_landings" type="number" min="0"></div>
      <div><label>Due Next (date)</label><br><input id="f_due_next_date" type="date"></div>
      <div><label>Due Next (hours)</label><br><input id="f_due_next_hours" type="number" min="0"></div>
      <div><label>Due Next (landings)</label><br><input id="f_due_next_landings" type="number" min="0"></div>
      <div><label>Status</label><br><input id="f_status"></div>
      <div><label>Status Note</label><br><input id="f_status_note"></div>
      <div><label>Part Number</label><br><input id="f_part_number"></div>
      <div><label>Part Serial</label><br><input id="f_part_serial"></div>
      <div><label>Last Completed (date)</label><br><input id="f_last_completed_date" type="date"></div>
      <div><label>Last Completed (hours)</label><br><input id="f_last_completed_hours" type="number" min="0"></div>
      <div><label>Last Completed (landings)</label><br><input id="f_last_completed_landings" type="number" min="0"></div>
      <div><label>Ciudad</label><br><input id="f_last_completed_city"></div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button onclick="saveItem()">Guardar</button>
      <button onclick="goItems()">Cancelar</button>
    </div>
  </section>

  <section id="screenAudit" class="hidden">
    <h2>Historial del aviÃ³n</h2>
    <div class="toolbar">
      <div class="row">
        <label class="small">
          <input type="checkbox" id="auditAll" onchange="state.auditPage=1; loadAudit()"> Todos los aviones
        </label>
      </div>
      <div class="row">
        <button onclick="prevAuditPage()">â—€ Anterior</button>
        <div id="auditPageInfo" class="small muted"></div>
        <button onclick="nextAuditPage()">Siguiente →</button>
      </div>
    </div>
    <div id="auditList" class="list"></div>
  </section>

<script>
const ROLE_LABELS = {
  admin: "Administrador",
  mechanic: "MecÃ¡nico",
  auditor: "Auditor",
};

const SCREENS = ["screenLogin","screenWelcome","screenItems","screenEdit","screenAudit","screenMTRs","screenMTRWizard"];

let state = {
  aircrafts: [],
  selectedAircraftId: null,
  items: [],
  page: 1,
  pageSize: 50,
  total: 0,
  editingItemId: null,
  showImportPanel: false,
  auditPage: 1,
  auditPageSize: 50,
  currentUser: null,
  sessionExpiresAt: null,
};

function el(id){ return document.getElementById(id); }

function show(screenId){
  SCREENS.forEach(id => el(id)?.classList.add("hidden"));
  el(screenId)?.classList.remove("hidden");
}

function setActive(tab){
  ["navWelcome","navItems","navAudit","navMTRs"].forEach(id => el(id)?.classList.remove("active"));
  el(tab)?.classList.add("active");
}

function roleLabel(role){ return ROLE_LABELS[role?.toLowerCase()] || role || ""; }
function roleIn(...roles){
  if (!state.currentUser) return false;
  const current = state.currentUser.role?.toLowerCase();
  return roles.map(r => r?.toLowerCase()).includes(current);
}
function isAdmin(){ return roleIn("admin"); }
function canCreateItems(){ return roleIn("admin","mechanic"); }
function canEditItems(){ return roleIn("admin"); }
function canImport(){ return roleIn("admin"); }
function canManageAircraft(){ return roleIn("admin"); }

function getToken(){ return localStorage.getItem("sessionToken"); }

function refreshRoleUI(){
  const header = el("appHeader");
  const logged = !!state.currentUser;
  if (header){ header.classList.toggle("hidden", !logged); }
  const userBox = el("userBox");
  if (userBox){ userBox.classList.toggle("hidden", !logged); }
  const userName = el("userName");
  const userRole = el("userRole");
  if (logged){
    if (userName) userName.textContent = state.currentUser.username;
    if (userRole) userRole.textContent = roleLabel(state.currentUser.role);
  } else {
    if (userName) userName.textContent = "";
    if (userRole) userRole.textContent = "";
  }
  const rowNew = el("rowNewAircraft");
  if (rowNew){ rowNew.classList.toggle("hidden", !canManageAircraft()); }
  const importBtn = el("btnImportCsv");
  if (importBtn){ importBtn.classList.toggle("hidden", !canImport()); }
  const addBtn = el("btnAddItem");
  if (addBtn){ addBtn.classList.toggle("hidden", !canCreateItems()); }
  // navEdit removido (botón en Items)
  const navItems = el("navItems");
  if (navItems){ navItems.classList.toggle("hidden", !logged); }
  const navAudit = el("navAudit");
  if (navAudit){ navAudit.classList.toggle("hidden", !logged); }
  const navMTRs = el("navMTRs");
  if (navMTRs){ navMTRs.classList.toggle("hidden", !logged); }
  const navWelcome = el("navWelcome");
  if (navWelcome){ navWelcome.classList.toggle("hidden", !logged); }
  const aircraftRow = el("aircraftRow");
  if (aircraftRow){ aircraftRow.classList.toggle("hidden", !logged); }
  const btnNewMTR = el('btnNewMTR');
  if (btnNewMTR){ btnNewMTR.classList.toggle('hidden', !(isAdmin() || roleIn('mechanic'))); }
  if (!canImport()){
    state.showImportPanel = false;
    renderImportPanel();
  }
  updateNavLinks();
}

function setSession(token, user, expiresAt){
  state.currentUser = user ? {...user} : null;
  state.sessionExpiresAt = expiresAt || null;
  // Guardar token opcionalmente para fallback por Authorization
  if (token){
    localStorage.setItem('sessionToken', token);
  } else {
    localStorage.removeItem('sessionToken');
  }
  if (user){
    localStorage.setItem('currentUser', JSON.stringify(user));
  }
  refreshRoleUI();
}

function clearSession(message){
  localStorage.removeItem('currentUser'); localStorage.removeItem('sessionToken');
  localStorage.removeItem("aircraftId");
  state.currentUser = null;
  state.sessionExpiresAt = null;
  state.aircrafts = [];
  state.selectedAircraftId = null;
  state.items = [];
  state.total = 0;
  state.page = 1;
  state.editingItemId = null;
  state.showImportPanel = false;
  const select = el("aircraftSelect");
  if (select){ select.innerHTML = ""; }
  const list = el("itemsList");
  if (list){ list.innerHTML = ""; }
  renderImportPanel();
  refreshRoleUI();
  show("screenLogin");
  const errorBox = el("loginError");
  if (errorBox){ errorBox.innerText = message || ""; }
}

async function restoreSession(){
  try {
    const res = await api('/auth/session');
    if (res && res.user){
      setSession(null, res.user, res.expires_at);
      const errorBox = el("loginError");
      if (errorBox) errorBox.innerText = "";
    }
  } catch (err) {
    if (err?.message){
      const errorBox = el("loginError");
      if (errorBox) errorBox.innerText = err.message;
    }
  }
}

async function api(path, opts={}){
  const { skipAuth, ...fetchOpts } = opts;
  const headers = new Headers(fetchOpts.headers || {});
  // AutenticaciÃ³n por cookie httpOnly; no agregamos Authorization
  if (!skipAuth){
    const t = getToken && getToken();
    if (t && !headers.has('Authorization')) headers.set('Authorization', 'Bearer ' + t);
  }
  fetchOpts.headers = headers;
  fetchOpts.credentials = 'include';
  const response = await fetch(path, fetchOpts);
  const contentType = response.headers.get('content-type') || '';
  const isJson = contentType.includes('application/json');
  let data = null;
  if (isJson){
    try { data = await response.json(); } catch(_) { data = null; }
  } else {
    data = await response.text();
  }
  if (response.status === 401 && !skipAuth){
    clearSession('Tu sesión expiró. Ingresa nuevamente.');
  }
  if (!response.ok){
    let detail = null;
    if (data && typeof data === 'object'){ detail = data.detail || data.message; }
    if (!detail && typeof data === 'string'){ detail = data; }
    throw new Error(detail || response.statusText || 'Error de red');
  }
  return data;
}

async function login(ev){
  if (ev) ev.preventDefault();
  const username = (el('loginUser').value || '').trim();
  const password = el('loginPass').value || '';
  if (!username || !password){
    el('loginError').innerText = 'Usuario y contraseña requeridos';
    return;
  }
  try {
    const res = await api('/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
      skipAuth: true,
    });
    setSession(res.token, res.user, res.expires_at);
    el('loginUser').value = '';
    el('loginPass').value = '';
    el('loginError').innerText = '';
    if (!location.hash){ location.hash = '#/welcome'; }
    await ensureAircrafts();
    router();
  } catch (err){
    el('loginError').innerText = err.message || 'No se pudo iniciar sesión';
  }
}

async function logout(){
  try { await api('/auth/logout', { method: 'POST' }); } catch(_) {}
  clearSession('');
}

window.addEventListener('hashchange', router);

async function router(){
  if (!state.currentUser){
    show('screenLogin');
    return;
  }
  updateNavLinks();
  const hash = location.hash || '#/welcome';
  const parts = hash.replace('#','').split('/').filter(Boolean);
  if (parts[0] === 'welcome'){
    setActive('navWelcome');
    show('screenWelcome');
    await ensureAircrafts();
    renderAircraftGrid();
    return;
  }
  if (parts[0] === 'aircraft' && parts[2] === 'items'){
    const aid = parseInt(parts[1] || '0');
    if (!aid || !state.aircrafts.find(a => a.id === aid)){
      await ensureAircrafts();
    }
    const fallbackId = state.selectedAircraftId || (state.aircrafts[0]?.id || 0);
    setSelectedAircraftId(aid || fallbackId);
    if (parts.length >= 4 && parts[3] === 'new'){
      if (!canCreateItems()){
        alert('No tienes permiso para agregar Ã­tems.');
        location.hash = `#/aircraft/${getSelectedAircraftId()}/items`;
        return;
      }
      setActive('navItems');
      show('screenEdit');
      state.editingItemId = null;
      clearForm();
      el('editTitle').innerText = 'Nuevo Ã­tem';
      return;
    }
    if (parts.length >= 5 && parts[4] === 'edit'){
      if (!canEditItems()){
        alert('No tienes permiso para editar Ã­tems.');
        location.hash = `#/aircraft/${getSelectedAircraftId()}/items`;
        return;
      }
      const itemId = parseInt(parts[3] || '0');
      setActive('navItems');
      show('screenEdit');
      state.editingItemId = itemId;
      el('editTitle').innerText = 'Editar Ã­tem #' + itemId;
      await loadItem(itemId);
      return;
    }
    setActive('navItems');
    show('screenItems');
    await loadItems();
    await updateTCInfo();
    if (localStorage.getItem('openImport') === '1'){
      state.showImportPanel = true;
      localStorage.removeItem('openImport');
    }
    renderImportPanel();
    return;
  }
  if (parts[0] === 'aircraft' && parts[2] === 'audit'){
    const aid = parseInt(parts[1] || '0');
    if (!aid || !state.aircrafts.find(a => a.id === aid)){
      await ensureAircrafts();
    }
    const fallbackId = state.selectedAircraftId || (state.aircrafts[0]?.id || 0);
    setSelectedAircraftId(aid || fallbackId);
    setActive('navAudit');
    show('screenAudit');
    state.auditPage = Number(state.auditPage) || 1;
    state.auditPageSize = Number(state.auditPageSize) || 50;
    await loadAudit();
    return;
  }
  if (parts[0] === 'mtrs'){
    if (parts.length === 1){
      setActive('navMTRs');
      show('screenMTRs');
      await loadMTRs();
      return;
    }
    if (parts.length >= 2 && parts[1] === 'new'){
      setActive('navMTRs');
      show('screenMTRWizard');
      state.mtrWizard = { mtrId: null, step: 1 };
      renderMTRStep1();
      return;
    }
    if (parts.length >= 3 && parts[2].startsWith('step')){
      const step = parseInt(parts[2].replace('step','') || '1');
      const mtrId = parseInt(parts[1] || '0');
      setActive('navMTRs');
      show('screenMTRWizard');
      state.mtrWizard = state.mtrWizard || { mtrId, step };
      state.mtrWizard.mtrId = mtrId;
      state.mtrWizard.step = step;
      await renderMTRWizard();
      return;
    }
  }
  location.hash = '#/welcome';
}

async function ensureAircrafts(){
  if (!state.currentUser){ return; }
  const ia = el('showArchived')?.checked ? 1 : 0;
  try {
    const list = await api('/aircraft' + (ia ? '?include_archived=1' : ''));
    state.aircrafts = list;
    const sel = el('aircraftSelect');
    if (sel){
      sel.innerHTML = '';
      list.forEach(a => sel.add(new Option(`#${a.id} ${a.name} (${a.model})`, a.id)));
    }
    const saved = parseInt(localStorage.getItem('aircraftId') || '0');
    const toUse = saved || (list[0]?.id || 0);
    if (toUse) setSelectedAircraftId(toUse);
    updateNavLinks();
  } catch(err){
    console.error(err);
  }
}

function updateNavLinks(){
  if (!state.currentUser){
    ['navWelcome','navItems','navAudit','navMTRs'].forEach(id => el(id)?.classList.add('disabled'));
    return;
  }
  const aid = getSelectedAircraftId() || 0;
  const items = el('navItems');
  const audit = el('navAudit');
  const mtrs  = el('navMTRs');
  // Asegurar que "Inicio" queda habilitado tras autenticarse
  const home  = el('navWelcome');
  if (home){
    home.classList.remove('disabled');
    home.href = '#/welcome';
  }
  if (mtrs){ mtrs.classList.remove('disabled'); mtrs.href = '#/mtrs'; }
  if (aid){
    items?.classList.remove('disabled');
    audit?.classList.remove('disabled');
    items && (items.href = `#/aircraft/${aid}/items`);
    audit && (audit.href = `#/aircraft/${aid}/audit`);
  } else {
    items?.classList.add('disabled');
    audit?.classList.add('disabled');
    if (items) items.href = '#/aircraft/0/items';
    if (audit) audit.href = '#/aircraft/0/audit';
  }
}

function getSelectedAircraftId(){
  const v = parseInt(el('aircraftSelect')?.value || '0');
  return v || (state.selectedAircraftId || 0);
}

function setSelectedAircraftId(id){
  const select = el('aircraftSelect');
  if (select){ select.value = String(id); }
  if (id){ localStorage.setItem('aircraftId', String(id)); }
  updateNavLinks();
  state.selectedAircraftId = id;
}

function onAircraftChange(){
  const id = getSelectedAircraftId();
  setSelectedAircraftId(id);
  const parts = (location.hash || '#/welcome').replace('#','').split('/').filter(Boolean);
  if (parts[0] === 'aircraft' && parts[2] === 'items'){
    if (parts.length >= 4 && parts[3] === 'new'){
      location.hash = `#/aircraft/${id}/items/new`;
    } else if (parts.length >= 5 && parts[4] === 'edit'){
      const itemId = parseInt(parts[3] || '0');
      location.hash = `#/aircraft/${id}/items/${itemId}/edit`;
    } else {
      location.hash = `#/aircraft/${id}/items`;
    }
    updateNavLinks();
    loadItems();
    updateTCInfo();
  } else if (parts[0] === 'aircraft' && parts[2] === 'audit'){
    location.hash = `#/aircraft/${id}/audit`;
  } else {
    updateNavLinks();
  }
}

function renderAircraftGrid(){
  if (!state.currentUser){ return; }
  const primary = (el('filterAircraft')?.value || '').toLowerCase();
  const query = primary;
  const cont = el('aircraftGrid');
  const list = state.aircrafts.filter(a => a.name.toLowerCase().includes(query));
  if (list.length === 0){
    cont.innerHTML = '<div class="muted">No hay aviones.</div>';
    return;
  }
  cont.innerHTML = list.map(a => {
    const archived = a.is_active === 0;
    const manageLinks = canManageAircraft();
    const importLink = canImport() ? `<a class="link" href="#/aircraft/${a.id}/items" onclick="localStorage.setItem('openImport','1')">Importar CSV</a>` : '';
    const actions = manageLinks ? (archived ? `<a class="link" href="#/aircraft/${a.id}/items" onclick="event.preventDefault(); restoreAircraft(${a.id})">Restaurar</a>` : `<a class="link" href="#/aircraft/${a.id}/items" onclick="event.preventDefault(); archiveAircraft(${a.id})">Archivar</a>`) : '';
    return `
      <div class="card">
        <div><b>${a.name}</b> <span class="muted">(${a.model || 'N/A'})</span></div>
        <div class="small muted">Creado: ${a.created_at}</div>
        ${archived ? `<div class="small warn">Archivado: ${a.archived_at || ''}</div>` : ''}
        <div style="margin-top:8px; display:flex; gap:14px; flex-wrap:wrap;">
          <a class="link" href="#/aircraft/${a.id}/items">Ver Ã­tems</a>
          ${importLink}
          ${actions}
        </div>
      </div>
    `;
  }).join('');
}

async function createAircraft(){
  if (!canManageAircraft()){ alert('No tienes permiso para crear aviones.'); return; }
  const name = el('newAircraftName').value.trim();
  const model = el('newAircraftModel').value.trim();
  if (!name){ alert('Nombre requerido'); return; }
  const fd = new FormData();
  fd.append('name', name);
  fd.append('model', model || 'N/A');
  try {
    const res = await api('/aircraft', { method: 'POST', body: fd });
    // Enviar TIME & CYCLES
    try {
      const body = {
        aircraft_hours: el('newTC_aircraft_hours')?.value,
        aircraft_landings: el('newTC_aircraft_landings')?.value,
        apu_hours: el('newTC_apu_hours')?.value,
        apu_cycles: el('newTC_apu_cycles')?.value,
        engine_1_hours: el('newTC_engine_1_hours')?.value,
        engine_1_cycles: el('newTC_engine_1_cycles')?.value,
        engine_2_hours: el('newTC_engine_2_hours')?.value,
        engine_2_cycles: el('newTC_engine_2_cycles')?.value,
      };
      await api(`/aircraft/${res.id}/time-cycles`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    } catch(_){}
    el('newAircraftName').value = '';
    el('newAircraftModel').value = '';
    await ensureAircrafts();
    renderAircraftGrid();
    const importar = confirm(`AviÃ³n creado (#${res.id}). Â¿Quieres importar un CSV ahora?`);
    if (importar){
      setSelectedAircraftId(res.id);
      state.showImportPanel = true;
      location.hash = `#/aircraft/${res.id}/items`;
    }
  } catch(err){
    alert('Error al crear aviÃ³n: ' + err.message);
  }
}

async function archiveAircraft(aid){
  if (!canManageAircraft()){ alert('No tienes permiso para archivar.'); return; }
  if (!confirm('Â¿Archivar este aviÃ³n? PodrÃ¡s restaurarlo luego.')) return;
  try {
    await api(`/aircraft/${aid}/archive`, { method:'POST' });
    await ensureAircrafts();
    renderAircraftGrid();
  } catch(err){ alert('No se pudo archivar: ' + err.message); }
}

async function restoreAircraft(aid){
  if (!canManageAircraft()){ alert('No tienes permiso para restaurar.'); return; }
  try {
    await api(`/aircraft/${aid}/restore`, { method:'POST' });
    await ensureAircrafts();
    renderAircraftGrid();
  } catch(err){ alert('No se pudo restaurar: ' + err.message); }
}

function goItemsFor(aid){ location.hash = `#/aircraft/${aid}/items`; }
function goItems(){ const aid = getSelectedAircraftId(); location.hash = `#/aircraft/${aid}/items`; }
function goNew(){
  if (!canCreateItems()){ alert('No tienes permiso para agregar Ã­tems.'); return; }
  const aid = getSelectedAircraftId();
  location.hash = `#/aircraft/${aid}/items/new`;
}

async function loadItems(){
  const aid = getSelectedAircraftId();
  if (!aid){ alert('Selecciona un aviÃ³n'); return; }
  state.pageSize = parseInt(el('pageSize').value || '50');
  const search = el('searchItems').value || '';
  const offset = (state.page-1) * state.pageSize;
  const qs = `?limit=${state.pageSize}&offset=${offset}${search ? '&search='+encodeURIComponent(search):''}`;
  try {
    const [items, count] = await Promise.all([
      api(`/aircraft/${aid}/items${qs}`),
      api(`/aircraft/${aid}/items/count${search ? '?search='+encodeURIComponent(search):''}`)
    ]);
    state.items = items;
    state.total = count.count;
  } catch(err){
    if (err?.message){ alert('No se pudieron cargar los items: ' + err.message); }
    return;
  }
  const totalPages = Math.max(1, Math.ceil(state.total/state.pageSize));
  el("pageInfo").innerText = "Pagina " + state.page + " de " + totalPages + " - Total: " + state.total;
  const list = el('itemsList');
  if (state.items.length === 0){
    list.innerHTML = '<div class="muted">Sin resultados.</div>';
    return;
  }
  list.innerHTML = state.items.map(r => {
    const editLink = canEditItems() ? `<a class="link" href="#/aircraft/${getSelectedAircraftId()}/items/${r.id}/edit">Editar</a>` : '';
    return `
      <div class="item">
        <div>
          <div><b>${escapeHtml(r.description || '(sin descripcion)')}</b></div>
          <div class="small muted">${escapeHtml(r.item_code || '')} | ${escapeHtml(r.position || '')} | ${escapeHtml(r.type || '')}</div>
          <div class="small">DueH: ${r.due_next_hours ?? ''} | DueL: ${r.due_next_landings ?? ''} | DueD: ${r.due_next_date ?? ''}</div>
          <div class="small muted">#${r.id}</div>
        </div>
        ${editLink}
      </div>
    `;
  }).join('');
}

function prevPage(){ if (state.page>1){ state.page--; loadItems(); } }
function nextPage(){ const totalPages = Math.max(1, Math.ceil(state.total/state.pageSize)); if (state.page<totalPages){ state.page++; loadItems(); } }

function renderImportPanel(){
  const panel = el('importPanel');
  if (!panel) return;
  const allowed = canImport();
  panel.classList.toggle('hidden', !(allowed && state.showImportPanel));
  if (!allowed || !state.showImportPanel){
    if (el('csvFile')) el('csvFile').value = '';
    if (el('importResult')) el('importResult').textContent = '';
  }
}

async function updateTCInfo(){
  const aid = getSelectedAircraftId();
  const box = el('tcInfo');
  if (!aid || !box){ return; }
  try {
    const tc = await api(`/aircraft/${aid}/time-cycles`);
    if (!tc){ box.innerHTML = '<span class="muted">TIME & CYCLES no registrados para este avión.</span>'; return; }
    box.innerHTML = `TIME & CYCLES — AH:${tc.aircraft_hours ?? ''} · AL:${tc.aircraft_landings ?? ''} · APUH:${tc.apu_hours ?? ''} · APUC:${tc.apu_cycles ?? ''} · E1H:${tc.engine_1_hours ?? ''} · E1C:${tc.engine_1_cycles ?? ''} · E2H:${tc.engine_2_hours ?? ''} · E2C:${tc.engine_2_cycles ?? ''} (act: ${tc.updated_at || ''})`;
  } catch(_) {
    if (box) box.innerHTML = '';
  }
}

function toggleImport(){
  if (!canImport()){ alert('No tienes permiso para importar.'); return; }
  state.showImportPanel = !state.showImportPanel;
  renderImportPanel();
}

async function importCSV(){
  if (!canImport()){ alert('No tienes permiso para importar.'); return; }
  const aid = getSelectedAircraftId();
  const f = el('csvFile').files[0];
  const mode = el('publishMode').value || 'quarantine';
  if (!aid){ alert('Selecciona un aviÃ³n'); return; }
  if (!f){ alert('Selecciona un archivo CSV'); return; }
  const fd = new FormData();
  fd.append('file', f);
  el('importResult').textContent = 'Subiendo y procesando...';
  try {
    const res = await api(`/aircraft/${aid}/imports?publish_mode=${encodeURIComponent(mode)}`, {
      method: 'POST',
      body: fd
    });
    const summary = [
      `Lote #${res.import_batch_id || 'N/A'}`,
      `Estado: ${res.status}`,
      `Total filas: ${res.total_rows}`,
      `Insertados: ${res.inserted_rows}`,
      `Cuarentena: ${res.quarantined || 0}`,
      `Errores: ${res.errors}`
    ].join('\n');
    el('importResult').textContent = summary;
    await loadItems();
  } catch(err){
    el('importResult').textContent = 'Error: ' + err.message;
  }
}

function clearForm(){
  ["f_item_code","f_position","f_description","f_type","f_interval_months","f_interval_hours","f_interval_landings",
   "f_due_next_date","f_due_next_hours","f_due_next_landings","f_status","f_status_note","f_part_number","f_part_serial",
   "f_last_completed_date","f_last_completed_hours","f_last_completed_landings","f_last_completed_city"].forEach(id => el(id).value = "");
  el('warnBox').innerText = '';
}

async function loadItem(id){
  clearForm();
  try {
    const r = await api(`/items/${id}`);
    setForm(r);
    if (r.due_next_date && r.last_completed_date && r.due_next_date < r.last_completed_date){
      el('warnBox').innerText = 'âš ï¸ El vencimiento es anterior a la Ãºltima finalizaciÃ³n. Revisa si es correcto.';
    }
  } catch(err){
    alert('No se pudo cargar el Ã­tem: ' + err.message);
  }
}

function setForm(r){
  el('f_item_code').value = r.item_code || '';
  el('f_position').value = r.position || '';
  el('f_description').value = r.description || '';
  el('f_type').value = r.type || '';
  el('f_interval_months').value = r.interval_months ?? '';
  el('f_interval_hours').value = r.interval_hours ?? '';
  el('f_interval_landings').value = r.interval_landings ?? '';
  el('f_due_next_date').value = r.due_next_date || '';
  el('f_due_next_hours').value = r.due_next_hours ?? '';
  el('f_due_next_landings').value = r.due_next_landings ?? '';
  el('f_status').value = r.status || '';
  el('f_status_note').value = r.status_note || '';
  el('f_part_number').value = r.part_number || '';
  el('f_part_serial').value = r.part_serial || '';
  el('f_last_completed_date').value = r.last_completed_date || '';
  el('f_last_completed_hours').value = r.last_completed_hours ?? '';
  el('f_last_completed_landings').value = r.last_completed_landings ?? '';
  el('f_last_completed_city').value = r.last_completed_city || '';
}

function getForm(){
  const v = (id) => el(id).value.trim();
  const toInt = (s) => s==='' ? null : parseInt(s,10);
  return {
    item_code: v('f_item_code') || null,
    position: v('f_position') || null,
    description: v('f_description') || null,
    type: v('f_type') || null,
    interval_months: toInt(v('f_interval_months')),
    interval_hours: toInt(v('f_interval_hours')),
    interval_landings: toInt(v('f_interval_landings')),
    due_next_date: v('f_due_next_date') || null,
    due_next_hours: toInt(v('f_due_next_hours')),
    due_next_landings: toInt(v('f_due_next_landings')),
    status: v('f_status') || null,
    status_note: v('f_status_note') || null,
    part_number: v('f_part_number') || null,
    part_serial: v('f_part_serial') || null,
    last_completed_date: v('f_last_completed_date') || null,
    last_completed_hours: toInt(v('f_last_completed_hours')),
    last_completed_landings: toInt(v('f_last_completed_landings')),
    last_completed_city: v('f_last_completed_city') || null,
  };
}

async function saveItem(){
  if (state.editingItemId && !canEditItems()){ alert('No tienes permiso para editar Ã­tems.'); return; }
  if (!state.editingItemId && !canCreateItems()){ alert('No tienes permiso para crear Ã­tems.'); return; }
  const aid = getSelectedAircraftId();
  const payload = getForm();
  if (!payload.description){ alert('La descripciÃ³n es requerida.'); return; }
  try {
    if (state.editingItemId){
      await api(`/items/${state.editingItemId}`, { method:'PUT', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      alert('Ãtem actualizado.');
    } else {
      await api(`/aircraft/${aid}/items`, { method:'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      alert('Ãtem creado.');
    }
    goItems();
    await loadItems();
  } catch(err){ alert('Error al guardar: ' + err.message); }
}

async function loadAudit(){
  const aid = getSelectedAircraftId();
  const pageSize = Number.isFinite(Number(state.auditPageSize)) ? Number(state.auditPageSize) : 50;
  const page = Number.isFinite(Number(state.auditPage)) ? Number(state.auditPage) : 1;
  const offset = Math.max(0, (page - 1) * pageSize);
  const qs = `?limit=${pageSize}&offset=${offset}`;
  const all = !!(el('auditAll') && el('auditAll').checked);
  const url = all ? `/audit${qs}` : `/aircraft/${aid}/audit${qs}`;
  try {
    const items = await api(url);
    el('auditPageInfo').innerText = `PÃ¡gina ${page}`;
    if (!Array.isArray(items) || items.length === 0){
      el('auditList').innerHTML = '<div class="muted small">No hay eventos para este criterio.</div>';
      return;
    }
    el('auditList').innerHTML = items.map(renderAuditItem2).join('');
  } catch(err){
    let msg = err?.message || String(err);
    try {
      if (msg === '[object Object]' || msg.includes('[object Object]')){
        msg = JSON.stringify(err);
      }
    } catch(_){}
    el('auditList').innerHTML = `<div class="err small">Error al cargar historial: ${escapeHtml(msg)}</div>`;
  }
}

function prevAuditPage(){ if (state.auditPage > 1){ state.auditPage--; loadAudit(); } }
function nextAuditPage(){ state.auditPage++; loadAudit(); }

function renderAuditItem(ev){
  const ts   = ev.ts;
  const tbl  = ev.table_name;
  const act  = ev.action;
  const rid  = ev.row_id;
  const det  = ev.details || {};
  const actor = ev.actor_username || (det && det.actor && det.actor.username) || '';
  let summary = '';

  if (tbl === 'aircraft'){
    if (act === 'CREATE'){
      summary = `âœˆï¸ Creado aviÃ³n "${escapeHtml(det?.values?.name || '')}" (${escapeHtml(det?.values?.model || '')})`;
    } else if (act === 'ARCHIVE'){
      summary = `ðŸ“¦ Archivado aviÃ³n "${escapeHtml(det?.name || '')}"`;
    } else if (act === 'RESTORE'){
      summary = `â™»ï¸ Restaurado aviÃ³n "${escapeHtml(det?.name || '')}"`;
    } else {
      summary = `âœˆï¸ Evento de aviÃ³n (${act})`;
    }
  } else if (tbl === 'maintenance_item'){
    if (act === 'INSERT'){
      summary = `âž• Ãtem creado (id=${rid})`;
    } else if (act === 'UPDATE'){
      const fields = det?.diff ? Object.keys(det.diff) : [];
      summary = `âœï¸ Ãtem actualizado (id=${rid}) â€” campos: ${fields.join(', ')}`;
    } else {
      summary = `Ãtem evento (${act}) (id=${rid})`;
    }
  } else if (tbl === 'import_batch'){
    summary = `ðŸ“¥ Lote ${rid} â€” acciÃ³n: ${act}`;
  } else {
    summary = `${tbl} â€” ${act}`;
  }

  let diffHtml = '';
  if (det && det.diff){
    const rows = Object.entries(det.diff).map(([k,v]) =>
      `<div class="small"><b>${escapeHtml(k)}</b>: ${escapeHtml(String(v.from))} â†’ ${escapeHtml(String(v.to))}</div>`
    ).join('');
    diffHtml = rows ? `<div style="margin-top:6px;">${rows}</div>` : '';
  }

  return `
    <div class="item">
      <div>
        <div class="small muted">${ts}${actor ? ' â€¢ por ' + escapeHtml(actor) : ''}</div>
        <div><b>${summary}</b></div>
        ${diffHtml}
      </div>
    </div>
  `;
}

// ===================== MTRs (lista) =====================
async function loadMTRs(){
  try {
    const rows = await api('/mtrs');
    const list = el('mtrList');
    if (!rows || rows.length === 0){
      list.innerHTML = '<div class="muted">No hay MTRs.</div>';
      return;
    }
    list.innerHTML = rows.map(r => `
      <div class="item" onclick="goMTRDetail(${r.id})" style="cursor:pointer;">
        <div>
          <div><b>MTR #${r.id}</b> Â· ${escapeHtml(r.aircraft_name || '')} (${escapeHtml(r.aircraft_model || '')})</div>
          <div class="small muted">Ciudad: ${escapeHtml(r.work_complete_city || '-')}
            Â· Estado: ${escapeHtml(r.status || '-')}
            Â· Ãtems: ${r.numero_de_items ?? 0}
            Â· Fecha: ${escapeHtml(r.date || '-')}
          </div>
        </div>
        <div class="pill">${escapeHtml(r.status || '')}</div>
      </div>
    `).join('');
  } catch(err){
    alert('No se pudo cargar MTRs: ' + err.message);
  }
}

function goMTRs(){ location.hash = '#/mtrs'; }
function goNewMTR(){ location.hash = '#/mtrs/new/step1'; }
function goMTRDetail(id){ location.hash = `#/mtrs/${id}/step6`; }

// ===================== MTRs (asistente) =====================
async function renderMTRWizard(){
  const step = (state.mtrWizard?.step) || 1;
  if (step === 1) return renderMTRStep1();
  if (step === 2) return renderMTRStep2();
  if (step === 3) return renderMTRStep3();
  if (step === 4) return renderMTRStep4();
  if (step === 5) return renderMTRStep5();
  return renderMTRStep6();
}

function mtrWizardNav(html){
  const step = state.mtrWizard?.step || 1;
  const id = state.mtrWizard?.mtrId || 0;
  const back = step <= 1 ? `<button onclick=\"goMTRs()\">Atrás</button>`
    : (step === 2 ? `<button onclick=\"goMTRs()\">Atrás</button>`
    : `<button onclick=\"location.hash='#/mtrs/${id}/step${step-1}'\">Atrás</button>`);
  return `
    <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
      <div>${back}</div>
      <div class="small muted">Paso ${step} de 6</div>
    </div>
    ${html}
  `;
}

function getTCInputs(prefix='tc_'){
  return {
    aircraft_hours: parseFloat(el(prefix+'aircraft_hours')?.value || '') || 0,
    aircraft_landings: parseInt(el(prefix+'aircraft_landings')?.value || '0') || 0,
    apu_hours: parseFloat(el(prefix+'apu_hours')?.value || '') || 0,
    apu_cycles: parseInt(el(prefix+'apu_cycles')?.value || '0') || 0,
    engine_1_hours: parseFloat(el(prefix+'engine_1_hours')?.value || '') || 0,
    engine_1_cycles: parseInt(el(prefix+'engine_1_cycles')?.value || '0') || 0,
    engine_2_hours: parseFloat(el(prefix+'engine_2_hours')?.value || '') || 0,
    engine_2_cycles: parseInt(el(prefix+'engine_2_cycles')?.value || '0') || 0,
  };
}

async function renderMTRStep1(){
  state.mtrWizard = state.mtrWizard || { step:1 };
  state.mtrWizard.step = 1;
  const aid = getSelectedAircraftId();
  let tc = null;
  if (aid){
    try { tc = await api(`/aircraft/${aid}/time-cycles`); } catch(_){}
  }
  const selOptions = (state.aircrafts||[]).map(a => `<option value="${a.id}" ${a.id===aid?'selected':''}>#${a.id} ${escapeHtml(a.name)} (${escapeHtml(a.model||'')})</option>`).join('');
  el('mtrWizard').innerHTML = mtrWizardNav(`
    <div class="list" style="max-width:720px;">
      <div>
        <label>Aeronave</label>
        <select id="w_aircraft_id">${selOptions}</select>
      </div>
      <div class="row" style="gap:12px;">
        <div style="flex:1;">
          <label>Fecha de finalizaciÃ³n</label>
          <input id="w_work_complete_date" type="date" value="${new Date().toISOString().slice(0,10)}" />
        </div>
        <div style="flex:1;">
          <label>Ciudad (IATA/ICAO)</label>
          <input id="w_work_complete_city" placeholder="BOG/MIA" />
        </div>
      </div>
      <div class="row" style="gap:12px;">
        <div style="flex:1;">
          <label>Serial</label>
          <input id="w_aircraft_serial_no" />
        </div>
        <div style="flex:1;">
          <label>Registro</label>
          <input id="w_aircraft_reg_no" />
        </div>
      </div>
      <div>
        <b>TIME & CYCLES</b>
        <div class="small muted">Complete horas/ciclos actuales (prefill si existe).</div>
        <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(160px,1fr));">
          ${["aircraft_hours","aircraft_landings","apu_hours","apu_cycles","engine_1_hours","engine_1_cycles","engine_2_hours","engine_2_cycles"].map(k=>`
            <div>
              <label>${k.replaceAll('_',' ')}</label>
              <input id="tc_${k}" value="${tc?.[k] ?? ''}" />
            </div>
          `).join('')}
        </div>
        <label class="small" style="margin-top:6px; display:block;">
          <input type="checkbox" id="w_update_air_tc" /> Actualizar registro del aviÃ³n con estos valores
        </label>
      </div>
      <div class="row" style="justify-content:flex-end; gap:8px;">
        <button onclick="goMTRs()">Cancelar</button>
        <button onclick="mtrStep1Submit()">Guardar y continuar</button>
      </div>
    </div>
  `);
}

async function mtrStep1Submit(){
  const aid = parseInt(el('w_aircraft_id').value||'0');
  const payload = {
    aircraft_id: aid,
    work_complete_date: el('w_work_complete_date').value,
    aircraft_serial_no: (el('w_aircraft_serial_no').value||'').trim(),
    aircraft_reg_no: (el('w_aircraft_reg_no').value||'').trim(),
    work_complete_city: (el('w_work_complete_city').value||'').trim(),
    time_cycles: getTCInputs('tc_'),
    update_aircraft_time_cycles: el('w_update_air_tc').checked
  };
  try {
    const res = await api('/mtrs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    state.mtrWizard.mtrId = res.id;
    location.hash = `#/mtrs/${res.id}/step2`;
  } catch(err){ alert('Error al crear MTR: ' + err.message); }
}

async function renderMTRStep2(){
  state.mtrWizard.step = 2;
  const mtr = await api(`/mtrs/${state.mtrWizard.mtrId}`);
  const aid = mtr.mtr.aircraft_id;
  el('mtrWizard').innerHTML = mtrWizardNav(`
    <div class="list">
      <div class="small muted">AviÃ³n #${aid} Â· Buscar y agregar Ã­tems por cÃ³digo.</div>
      <div class="row">
        <input id="w_search_code" placeholder="Buscar por cÃ³digo o descripciÃ³n" />
        <button onclick="mtrSearchItems(${aid})">Buscar</button>
      </div>
      <div id="w_search_results" class="list"></div>
      <div style="margin-top:8px; display:flex; justify-content:flex-end; gap:8px;">
        <button onclick="location.hash='#/mtrs/${state.mtrWizard.mtrId}/step3'">Continuar</button>
      </div>
    </div>
  `);
}

async function mtrSearchItems(aid){
  const q = el('w_search_code').value||'';
  try {
    const items = await api(`/aircraft/${aid}/items?limit=25&offset=0&search=${encodeURIComponent(q)}`);
    el('w_search_results').innerHTML = (items||[]).map(r => `
      <div class="item">
        <div>
          <div><b>${escapeHtml(r.item_code||'')}</b> Â· ${escapeHtml(r.description||'')}</div>
          <div class="small muted">${escapeHtml(r.position||'')} Â· ${escapeHtml(r.type||'')}</div>
        </div>
        <button onclick="mtrAddItem(${state.mtrWizard.mtrId}, '${r.item_code?.replaceAll('"','&quot;') || ''}')">Agregar</button>
      </div>
    `).join('');
  } catch(err){ alert('No se pudo buscar Ã­tems: ' + err.message); }
}

async function mtrAddItem(mtrId, code){
  try {
    await api(`/mtrs/${mtrId}/items`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ item_code: code }) });
    alert('Ãtem agregado');
  } catch(err){ alert('No se pudo agregar: ' + err.message); }
}

async function renderMTRStep3(){
  state.mtrWizard.step = 3;
  const data = await api(`/mtrs/${state.mtrWizard.mtrId}`);
  const items = data.items||[];
  el('mtrWizard').innerHTML = mtrWizardNav(`
    <div class="list">
      ${items.length===0?'<div class="muted">AÃºn no has agregado Ã­tems.</div>':''}
      ${items.map(it=>`
        <div class="item">
          <div>#${it.id} Â· <b>${escapeHtml(it.item_code||'')}</b></div>
          <div style="flex:1; margin-left:8px;"><input id="desc_${it.id}" placeholder="DescripciÃ³n del Ã­tem" value="${escapeHtml(it.description||'')}"></div>
          <button onclick="mtrRemoveItem(${state.mtrWizard.mtrId}, ${it.id})">Eliminar</button>
        </div>
      `).join('')}
      <div style="display:flex; justify-content:flex-end; gap:8px;">
        <button onclick="location.hash='#/mtrs/${state.mtrWizard.mtrId}/step2'">AtrÃ¡s</button>
        <button onclick="mtrStep3Save()">Guardar y continuar</button>
      </div>
    </div>
  `);
}

async function mtrRemoveItem(mtrId, id){
  try { await api(`/mtrs/${mtrId}/items/${id}`, { method:'DELETE' }); location.hash = `#/mtrs/${mtrId}/step3`; } catch(err){ alert('Error: '+err.message); }
}

async function mtrStep3Save(){
  const data = await api(`/mtrs/${state.mtrWizard.mtrId}`);
  const items = data.items||[];
  for (const it of items){
    const val = (el(`desc_${it.id}`).value||'').trim();
    if (!val){ alert('Todos los Ã­tems requieren descripciÃ³n'); return; }
  }
  for (const it of items){
    const val = (el(`desc_${it.id}`).value||'').trim();
    if (val !== (it.description||'')){
      await api(`/mtrs/${state.mtrWizard.mtrId}/items/${it.id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ description: val }) });
    }
  }
  location.hash = `#/mtrs/${state.mtrWizard.mtrId}/step4`;
}

async function renderMTRStep4(){
  state.mtrWizard.step = 4;
  const data = await api(`/mtrs/${state.mtrWizard.mtrId}`);
  const items = data.items||[];
  el('mtrWizard').innerHTML = mtrWizardNav(`
    <div class="list">
      ${(items||[]).map(it=>`<div class=\"item\"><div><b>${escapeHtml(it.item_code||'')}</b></div><div>${escapeHtml(it.description||'')}</div></div>`).join('')}
      <div style="display:flex; justify-content:flex-end; gap:8px;">
        <button onclick="location.hash='#/mtrs/${state.mtrWizard.mtrId}/step3'">AtrÃ¡s</button>
        <button onclick="mtrConfirmItems()">Confirmar Ã­tems</button>
      </div>
    </div>
  `);
}

async function mtrConfirmItems(){
  try { await api(`/mtrs/${state.mtrWizard.mtrId}/confirm-items`, { method:'POST' }); location.hash = `#/mtrs/${state.mtrWizard.mtrId}/step5`; } catch(err){ alert('No se pudo confirmar: '+err.message); }
}

async function renderMTRStep5(){
  state.mtrWizard.step = 5;
  const mtr = (await api(`/mtrs/${state.mtrWizard.mtrId}`)).mtr;
  function val(k){ return escapeHtml(mtr[k]||''); }
  el('mtrWizard').innerHTML = mtrWizardNav(`
    <div class="list" style="max-width:720px;">
      <b>REPAIR FACILITY</b>
      <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr));">
        ${[['repair_facility','Facility'],['facility_certificate','Certificado'],['work_order_number','Orden de trabajo'],['work_performed_by','Realizado por'],['performer_certificate_number','Certificado del ejecutor'],['repair_date','Fecha (YYYY-MM-DD)']].map(([k,l])=>`
          <div>
            <label>${l}</label>
            <input id="rf_${k}" value="${val(k)}" />
          </div>
        `).join('')}
      </div>
      <b style="margin-top:10px;">INSPECTION</b>
      <div>
        <label>DeclaraciÃ³n adicional</label>
        <input id="rf_additional_certification_statement" value="${val('additional_certification_statement')||'The aircraft identified above is presently approved for return to service.'}" />
      </div>
      <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr));">
        ${[['work_inspected_by','Inspeccionado por'],['inspector_certificate_number','Certificado del inspector'],['inspection_date','Fecha de inspecciÃ³n (YYYY-MM-DD)']].map(([k,l])=>`
          <div>
            <label>${l}</label>
            <input id="rf_${k}" value="${val(k)}" />
          </div>
        `).join('')}
      </div>
      <div style="display:flex; justify-content:flex-end; gap:8px;">
        <button onclick="location.hash='#/mtrs/${state.mtrWizard.mtrId}/step4'">AtrÃ¡s</button>
        <button onclick="mtrStep5Save()">Guardar y continuar</button>
      </div>
    </div>
  `);
}

async function mtrStep5Save(){
  const collect = k => (el('rf_'+k)?.value||'');
  const body = {
    repair_facility: collect('repair_facility'),
    facility_certificate: collect('facility_certificate'),
    work_order_number: collect('work_order_number'),
    work_performed_by: collect('work_performed_by'),
    performer_certificate_number: collect('performer_certificate_number'),
    repair_date: collect('repair_date'),
    additional_certification_statement: collect('additional_certification_statement'),
    work_inspected_by: collect('work_inspected_by'),
    inspector_certificate_number: collect('inspector_certificate_number'),
    inspection_date: collect('inspection_date'),
  };
  try { await api(`/mtrs/${state.mtrWizard.mtrId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }); location.hash = `#/mtrs/${state.mtrWizard.mtrId}/step6`; } catch(err){ alert('Error al guardar: '+err.message); }
}

async function renderMTRStep6(){
  state.mtrWizard.step = 6;
  const data = await api(`/mtrs/${state.mtrWizard.mtrId}`);
  const m = data.mtr, items = data.items||[], tc = data.time_cycles;
  el('mtrWizard').innerHTML = mtrWizardNav(`
    <div class="list">
      <div class="card"><b>INFO</b><div class="small">AviÃ³n #${m.aircraft_id} Â· Fecha: ${escapeHtml(m.work_complete_date||'')} Â· Ciudad: ${escapeHtml(m.work_complete_city||'')}</div></div>
      <div class="card"><b>TIME & CYCLES</b><div class="small">AH:${tc?.aircraft_hours??''} AL:${tc?.aircraft_landings??''} APUH:${tc?.apu_hours??''} APUC:${tc?.apu_cycles??''} E1H:${tc?.engine_1_hours??''} E1C:${tc?.engine_1_cycles??''} E2H:${tc?.engine_2_hours??''} E2C:${tc?.engine_2_cycles??''}</div></div>
      <div class="card"><b>Ãtems (${items.length})</b>${items.map(it=>`<div class=\"small\">${escapeHtml(it.item_code||'')} Â· ${escapeHtml(it.description||'')}</div>`).join('')}</div>
      <div class="card"><b>REPAIR FACILITY</b><div class="small">${escapeHtml(m.repair_facility||'')} Â· ${escapeHtml(m.work_performed_by||'')} Â· ${escapeHtml(m.repair_date||'')}</div></div>
      <div class="card"><b>INSPECTION</b><div class="small">${escapeHtml(m.work_inspected_by||'')} Â· ${escapeHtml(m.inspection_date||'')}</div></div>
      <div style="display:flex; justify-content:flex-end; gap:8px;">
        <button onclick="location.hash='#/mtrs/${state.mtrWizard.mtrId}/step5'">Atrás</button>
        <button onclick="location.hash='#/mtrs/${state.mtrWizard.mtrId}/step2'">Editar</button>
        <button onclick="deleteMTR(${state.mtrWizard.mtrId})">Eliminar</button>
        <button onclick="goMTRs()">Guardar borrador</button>
        <button onclick="mtrSubmit()">Enviar</button>
      </div>
    </div>
  `);
}

async function deleteMTR(id){
  if (!confirm('¿Eliminar este MTR (borrador)?')) return;
  try { await api(`/mtrs/${id}`, { method:'DELETE' }); goMTRs(); await loadMTRs(); } catch(err){ alert('No se pudo eliminar: '+err.message); }
}

function editMTR(id){ location.hash = `#/mtrs/${id}/step2`; }

async function mtrSubmit(){
  try { const res = await api(`/mtrs/${state.mtrWizard.mtrId}/submit`, { method:'POST' }); alert('MTR enviado'); goMTRs(); } catch(err){ alert('No se pudo enviar: '+err.message); }
}

// Limpieza de textos con codificaciÃ³n correcta para el historial
function renderAuditItem2(ev){
  const ts   = ev.ts;
  const tbl  = ev.table_name;
  const act  = ev.action;
  const rid  = ev.row_id;
  const det  = ev.details || {};
  const actor = ev.actor_username || (det && det.actor && det.actor.username) || '';
  let summary = '';

  if (tbl === 'aircraft'){
    if (act === 'CREATE'){
      summary = `âœˆï¸ Creado aviÃ³n "${escapeHtml(det?.values?.name || '')}" (${escapeHtml(det?.values?.model || '')})`;
    } else if (act === 'ARCHIVE'){
      summary = `ðŸ“¦ Archivado aviÃ³n "${escapeHtml(det?.name || '')}"`;
    } else if (act === 'RESTORE'){
      summary = `â™»ï¸ Restaurado aviÃ³n "${escapeHtml(det?.name || '')}"`;
    } else {
      summary = `âœˆï¸ Evento de aviÃ³n (${act})`;
    }
  } else if (tbl === 'maintenance_item'){
    if (act === 'INSERT'){
      summary = `ðŸ§© Ãtem creado (id=${rid})`;
    } else if (act === 'UPDATE'){
      const fields = det?.diff ? Object.keys(det.diff) : [];
      summary = `ðŸ› ï¸ Ãtem actualizado (id=${rid}) â€” campos: ${fields.join(', ')}`;
    } else {
      summary = `Evento de Ã­tem (${act}) (id=${rid})`;
    }
  } else if (tbl === 'import_batch'){
    summary = `ðŸ“¦ Lote ${rid} â€” acciÃ³n: ${act}`;
  } else {
    summary = `${tbl} â€” ${act}`;
  }

  let diffHtml = '';
  if (det && det.diff){
    const rows = Object.entries(det.diff).map(([k,v]) =>
      `<div class="small"><b>${escapeHtml(k)}</b>: ${escapeHtml(String(v.from))} â†’ ${escapeHtml(String(v.to))}</div>`
    ).join('');
    diffHtml = rows ? `<div style="margin-top:6px;">${rows}</div>` : '';
  }

  return `
    <div class="item">
      <div>
        <div class="small muted">${ts}${actor ? ' Â· por ' + escapeHtml(actor) : ''}</div>
        <div><b>${summary}</b></div>
        ${diffHtml}
      </div>
    </div>
  `;
}

function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

(async () => {
  await restoreSession();
  if (!state.currentUser){
    show('screenLogin');
    return;
  }
  if (!location.hash) location.hash = '#/welcome';
  await ensureAircrafts();
  router();
})();
</script>
</body>
</html>

















